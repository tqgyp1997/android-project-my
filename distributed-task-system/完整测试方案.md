# 🧪 闲鱼分布式任务系统 - 完整测试方案

## 🎯 测试目标

验证分布式任务系统的完整工作流程：
1. **服务器启动** - 分布式任务服务器正常运行
2. **设备连接** - Android APP成功连接服务器
3. **任务分发** - 服务器向APP分发任务
4. **任务执行** - APP执行任务并返回结果
5. **状态监控** - 实时监控任务执行状态

## 📋 测试步骤

### 第一步：启动分布式任务服务器

```bash
# 进入服务器目录
cd distributed-task-system/server

# 安装依赖
pip install -r requirements.txt

# 启动服务器
python app.py
```

**预期结果：**
- ✅ 服务器在端口1888启动成功
- ✅ 显示"分布式任务系统启动成功"
- ✅ WebSocket服务正常运行

### 第二步：构建并安装Android APP

```bash
# 进入Android项目目录
cd distributed-task-system/android-app

# 运行构建脚本
快速构建APK.bat
```

**预期结果：**
- ✅ APK文件构建成功
- ✅ 文件位置：app/build/outputs/apk/debug/app-debug.apk
- ✅ 文件大小约5-10MB

### 第三步：安装APP到手机

1. **传输APK文件**
   - 将APK文件传输到Android手机
   - 启用"未知来源"安装权限

2. **安装应用**
   - 点击APK文件安装
   - 授予必要权限

**预期结果：**
- ✅ APP安装成功
- ✅ 应用图标出现在桌面
- ✅ 应用名称："闲鱼任务执行器"

### 第四步：配置网络连接

1. **获取电脑IP地址**
   ```bash
   ipconfig
   # 记录电脑的局域网IP，如：192.168.1.100
   ```

2. **在APP中配置服务器地址**
   - 打开"闲鱼任务执行器"
   - 输入服务器地址：`http://192.168.1.100:1888`
   - 点击"连接"按钮

**预期结果：**
- ✅ APP显示"连接中..."
- ✅ 服务器端显示设备连接日志
- ✅ APP显示"已连接"状态

### 第五步：设备注册验证

**服务器端检查：**
- 查看控制台日志，应显示：
  ```
  [INFO] 设备注册成功: device_xxx
  [INFO] 设备信息: Android 设备名称
  ```

**APP端检查：**
- 设备状态：已注册
- 连接状态：已连接
- 心跳状态：正常

**预期结果：**
- ✅ 设备成功注册到服务器
- ✅ 双向通信建立成功
- ✅ 心跳机制正常工作

### 第六步：任务分发测试

1. **发送测试任务**
   ```bash
   # 使用测试脚本发送任务
   cd distributed-task-system
   python test_app_delist.py
   ```

2. **任务内容示例**
   ```json
   {
     "task_id": "test_001",
     "task_type": "DELIST",
     "data": {
       "product_ids": ["test123", "test456"],
       "batch_size": 2
     }
   }
   ```

**预期结果：**
- ✅ 服务器成功发送任务
- ✅ APP接收到任务通知
- ✅ APP显示"执行中"状态

### 第七步：任务执行验证

**APP端行为：**
1. 接收任务数据
2. 启动WebView执行环境
3. 模拟执行下架操作
4. 上报执行进度
5. 返回执行结果

**服务器端监控：**
- 任务状态：执行中 → 已完成
- 执行结果：成功/失败
- 处理数量：实际处理的商品数

**预期结果：**
- ✅ 任务执行成功
- ✅ 返回正确的执行结果
- ✅ 状态更新及时准确

## 🔍 详细测试命令

### 连接测试命令

1. **测试WebSocket连接**
   ```javascript
   // 在浏览器控制台执行
   const socket = io('http://192.168.1.100:1888');
   socket.on('connect', () => console.log('连接成功'));
   ```

2. **测试HTTP API**
   ```bash
   curl http://192.168.1.100:1888/api/devices
   # 应返回已连接的设备列表
   ```

### 任务测试命令

1. **发送简单测试任务**
   ```bash
   curl -X POST http://192.168.1.100:1888/api/tasks \
     -H "Content-Type: application/json" \
     -d '{
       "task_type": "TEST",
       "data": {"message": "Hello from server"}
     }'
   ```

2. **查看任务状态**
   ```bash
   curl http://192.168.1.100:1888/api/tasks/status
   ```

## 📊 成功标准

### 基础连接测试 ✅
- [ ] 服务器启动成功（端口1888）
- [ ] APP安装成功
- [ ] 设备连接成功
- [ ] WebSocket通信正常

### 功能测试 ✅
- [ ] 设备注册成功
- [ ] 任务分发成功
- [ ] 任务执行成功
- [ ] 结果返回正确

### 稳定性测试 ✅
- [ ] 连接断开自动重连
- [ ] 任务执行异常处理
- [ ] 长时间运行稳定

## 🐛 常见问题排查

### 连接失败
1. **检查网络**：确保手机和电脑在同一WiFi
2. **检查防火墙**：关闭Windows防火墙或添加例外
3. **检查端口**：确认1888端口未被占用

### 任务执行失败
1. **检查权限**：确保APP有必要的权限
2. **检查WebView**：确认WebView功能正常
3. **查看日志**：通过adb logcat查看详细日志

### 性能问题
1. **内存使用**：监控APP内存占用
2. **电量消耗**：检查后台运行影响
3. **网络流量**：监控数据传输量

## 🎉 测试完成标志

当以下所有项目都显示✅时，说明系统测试完全成功：

- ✅ 分布式任务服务器正常运行
- ✅ Android APP成功连接
- ✅ 设备注册和心跳正常
- ✅ 任务分发和执行成功
- ✅ 状态监控实时准确
- ✅ 异常处理机制有效

**恭喜！您的闲鱼分布式任务系统已经完全就绪！** 🎊
